#!/bin/bash

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Docker Composeã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•ã—ã€åˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ

echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ä¸­..."
docker-compose up -d

echo "â³ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­..."

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
max_attempts=30
attempt=0

while [ $attempt -lt $max_attempts ]; do
    # PostgreSQLã«æ¥ç¶šã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆ
    if docker-compose exec -T postgres pg_isready -h localhost -p 5432 -U test > /dev/null 2>&1; then
        echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ"
        break
    fi
    
    attempt=$((attempt + 1))
    echo "  å¾…æ©Ÿä¸­... ($attempt/$max_attempts)"
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi

echo "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"
echo "ğŸ“ Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: npx prisma migrate dev"
